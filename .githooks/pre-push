#!/usr/bin/env bash
set -euo pipefail

# Fast pre-push: format-check + eslint only (tests on CI)
# Prefer host (node_modules) for speed; fallback to Docker.

COMPOSE=(docker compose -f docker-compose.yml -f docker-compose.dev.yml)

run_local() {
  echo "[pre-push] Prettier --check (local)"
  npx prettier --ignore-unknown --check .
  echo "[pre-push] ESLint (local)"
  npx eslint . --ext .ts,.tsx
}

run_docker() {
  echo "[pre-push] Format check + ESLint (docker)"
  "${COMPOSE[@]}" run --rm -T tools sh -lc 'npm run --silent format:check && npm run --silent lint:eslint'
}

if [ -d node_modules ] && command -v npx >/dev/null 2>&1; then
  run_local || run_docker
else
  run_docker
fi

echo "[pre-push] Lint/format passed. Proceeding with push."
